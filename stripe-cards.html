<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="./card-preview.html">
<link rel="import" href="./no-card.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="./stripe-script.html">
<link rel="import" href="./stripe-elements.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">

<dom-module id="stripe-cards">
  <template>
    <style>
      :host {
        display: block;
        --stripe-elements-base-color: #32325d;
        --stripe-elements-base-line-height: 18px;
        --stripe-elements-base-font-family: "Roboto", "Noto", sans-serif;
        --stripe-elements-base-font-smoothing: antialiased;
        --stripe-elements-base-font-size: 14px;
        --card-preview-card-details: {
          border-radius: 0px;
          margin: 4px;
        };
      }

      .add-fab {
        float: right;
        background-color: #008cdd;
      }

      .card-container {
        width: calc(100% - 82px);
        float: left;
      }

      .card-container iframe {
        width:100%;
      }

      .add-button {
        width: 72px;
        margin: 4px;
        height: 37px;
        line-height: 37px;
        text-align: center;
        background-color: #008cdd;
        color: #fff;
        border: solid 1px transparent;
        box-shadow: 2px 2px 3px 0px #bbbfc4;
        -webkit-transition: box-shadow 150ms ease;
        transition: box-shadow 150ms ease;
        float: left;
        cursor: pointer;
      }

      .clearfix {
        clear: both;
      }
      
      no-card {
        opacity: 1;
        display: block;
        visibility: visible;
        transition: visibility 0s, opacity 0.5s linear;
      }

      *[hidden] {
        visibility: hidden;
        display: none;
        opacity: 0;
      }
    </style>
    <h2>[[titleString]]</h2>
    <no-card hidden$="[[!_noCards(cards.length)]]">No Cards!!!</no-card>
    <dom-repeat id="cardList" items="[[cards]]" filter="_isVisible" sort="_cardSort">
      <template>
        <card-preview last4="[[item.last4]]"
                      type="[[item.type]]" 
                      expiry-month="[[item.expiryMonth]]"
                      expiry-year="[[item.expiryYear]]"
                      status="[[item.status]]" 
                      is-default="[[item.isDefault]]" 
                      can-remove="[[_canRemove(item, cards.length)]]"
                      on-remove="_onRemoveCard"
                      on-tag="_onCardTagged"></card-preview>
      </template>
    </dom-repeat>
    <div id="add-card-container" hidden$="[[!_isAdding]]">
        <stripe-elements
            class="card-container"
            id="stripe" 
            stripe-ready="{{ready}}"
            publishable-key="[[publishableKey]]"
            token="{{token}}"
            on-stripe-error="_handleTokenError"
            on-stripe-token="_handleTokenResponse"
        ></stripe-elements>
        <paper-button class="add-button" on-click="_hideAddCard" hidden$="[[!_canCancel(cards.length)]]">Cancel</paper-button>
        <paper-button class="add-button cancel-button" on-click="_onAddCard">Save</paper-button>
      <div class="clearfix"></div>
    </div>
    <div hidden$="[[_isAdding]]">
      <paper-fab id="add-fab" mini icon="icons:add" class="add-fab" on-click="_showAddCard"></paper-fab>
    </div>
    <div class="clearfix"></div>

  </template>

  <script>
    /**
     * `stripe-cards`
     * Manage your stripe cards
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class StripeCards extends Polymer.Element {
      static get is() { return 'stripe-cards'; }
      
      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();
      }

      static get properties() {
        return {
          titleString: {
            type: String,
            value: 'Credit Cards: '
          },
          cards: {
            type: Array,
            value: function() {
              return [];
            },
            notify: true
          },
          publishableKey: {
            type: String,
            value: null
          },
          _visibleStatuses: {
            type: Array,
            value: ['added', 'active', 'pending', 'removing']
          },
          _removeableStatuses: {
            type: Array,
            value: ['added', 'active']
          },
          _isAdding: {
            type: Boolean,
            value: false
          }
        };
      }

      _canCancel(length) {
        return length > 0;
      }

      _onRemoveCard(e) {
        var item = this.$.cardList.itemForElement(e.target);
        var i = this.$.cardList.indexForElement(e.target);
        this._removeCard(item);
      }

      _onCardTagged(e) {
        var item = this.$.cardList.itemForElement(e.target);
        var i = this.$.cardList.indexForElement(e.target);
        if (!!e.detail.default) {
          this.cards.filter(x => x.isDefault).forEach(x => { x.isDefault = false; console.log(x); });
          item.isDefault = true;
          this.notifySplices('cards');
        }
      }

      _addCard(card) {
        var newCard = {
          last4: card.last4, 
          expiryMonth: card['exp_month'],
          expiryYear: card['exp_year'],
          type: card.brand.toLowerCase(), 
          canRemove: true, 
          status: 'active',
          isDefault: false
        };
        this.push('cards', newCard);
      }

      _onAddCard(e) {
        this.$.stripe.submit();
      }

      _stripeTokenHandler(token) {
        console.log('Got Token:', token);
      }

      _removeCard(card) {
        var index = this.cards.indexOf(card);
        if (index > -1) {
          this.splice('cards', index, 1);
        } else {
          console.warn('can\'t remove the card');
        }
      }

      /*
      For card list filtering
      */
      _isVisible(item) {
        var i = this._visibleStatuses.indexOf(item.status);
        return i >= 0;
      }

      expiryDate(year, month) {
        let m = `${month}`.padStart(2,'0');
        return `${year}${m}`*1;
      }

      _cardSort(a, b) {
        // default first
        let ae = this.expiryDate(a.expiryYear, a.expiryMonth);
        let be = this.expiryDate(b.expiryYear, b.expiryMonth);
        if (a.isDefault && b.isDefault) {
          return ae < be ? -1 : 1;
        }
        if (a.isDefault || b.isDefault) {
          return a.isDefault ? -1 : 1;
        }
        if (a.isDefault == b.isDefault) {
          if (ae === be) return 0;
          return ae < be ? -1 : 1;
        }
        return ae < be ? -1 : 1;
      }

      _showAddCard() {
        var element1 = this.$['add-fab'];
        var element2 = this.$['add-card-container'];
        this._isAdding = true;
      }

      resetCard() {
        this.$.stripe.reset();
      }

      _hideAddCard() {
        this._isAdding = false;
        this.resetCard();
      }

      _noCards(cardCount) {
        console.log('_noCards', cardCount, cardCount <= 0);
        return cardCount <= 0;
      }

      _canRemove(item, cardCount) {
        var i = this._removeableStatuses.indexOf(item.status);
        return (cardCount > 1) && (i >= 0) && !item.isDefault && !!item.canRemove;
      }

      _handleTokenResponse(e) {
        console.log('TokenReponse: ', e.detail.token);
        const bubbles = true;
        const composed = true;
        // this._addCard(e.detail.token.card);
        this.dispatchEvent(new CustomEvent('card-token', {detail: { token: e.detail.token }, bubbles, composed}));
        this._hideAddCard();
      }

      _handleTokenError(e) {
        console.log('TokenError: ', e);
        const bubbles = true;
        const composed = true;
        this.dispatchEvent(new CustomEvent('card-error', {detail: { error: e.detail.error }, bubbles, composed}));
      }

    }

    window.customElements.define(StripeCards.is, StripeCards);
  </script>
</dom-module>
